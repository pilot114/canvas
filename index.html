<!DOCTYPE html>
<html>
<head>
	<title>flat world</title>
	<style>
		.line {
			fill: none;
			stroke: #000;
			stroke-width: 1.5px;
		}
		#container {
			display: flex;
		}
		#info {
			width: 250px;
			height: 240px;
		}
		#graph {
			flex: 1;
		}
		#canvas {
			width: 1200px;
			height: 600px;
			background-color: #ddd
		}
		#selectInfo {
			position: absolute;
			top: 0px;
			left: 700px;
		}
	</style>
</head>
<body>
	<div id="container">
		<div id="info">
			<div id="worldInfo"></div>
			<hr>
			<div id="countsInfo"></div>
			<div id="selectInfo"></div>
		</div>
		<svg id="graph" width="400" height="200"></svg>
	</div>
	<canvas id="canvas"></canvas>

</body>
<script src="http://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="./Helpers.js"></script>
<script type="text/javascript" src="./Animation.js"></script>
<script type="text/javascript" src="./Behavior.js"></script>
<script type="text/javascript" src="./Lifers.js"></script>
<script type="text/javascript" src="./World.js"></script>
<script type="text/javascript" src="./Graph.js"></script>
<script type="text/javascript" src="./Memory.js"></script>

<script type="text/javascript">

window.onload = function() {
	let canvas = document.getElementById('canvas');
    let context = canvas.getContext('2d');
	canvas.width = 1200;
	canvas.height = 600;

    canvas.addEventListener("click", function(event){
        let eventLocation = getEventLocation(this, event);
        world.selectByLocation(eventLocation);
    });


    let world = new World(canvas.width, canvas.height);
	createLifers(world, "Wolf", 20);
	createLifers(world, "Cow", 100);
	createLifers(world, "Grass", 150);

    // createRandomLifers(world, 1000);

    let fps = 60;
    let start = Date.now();
    let x = Date.now();
    let interval = 1000/fps;
    let delta;
    let now;

    (function draw() {
	    requestAnimationFrame(draw);

        now = Date.now();
        delta = now - x;
        x = now - delta % interval;

        if (delta > interval) {
            context.clearRect(0, 0, canvas.width, canvas.height);

            world.update(now-start);
            world.draw(context);

            if (Math.random() > 0.5) {
                createLifers(world, "Grass", 1);
			}


            // info block
            // document.getElementById('worldInfo').innerText = JSON.stringify({
				// tick: world.tick,
				// ms: world.ms,
            //     fps: Math.round(1000/(world.ms/world.tick)), // просто проверка
            //     memory: memorySizeOf(world)
            // });

            document.getElementById('worldInfo').innerText = objectToString({
                tick: world.tick,
                ms: world.ms,
                fps: Math.round(1000 / (world.ms / world.tick)), // просто проверка
                historyMemory: memorySizeOf(world.history),
            });

			document.getElementById('countsInfo').innerText = objectToString(world.getCounts());

            if (world.select) {
                let output = '';
                for (let property in world.select) {
                    if (typeof world.select[property] != 'function') {
                        output += property + ': ' + world.select[property]+"\n";
					}
                }

                document.getElementById('selectInfo').innerText = output;
			} else {
                document.getElementById('selectInfo').innerText = '';
			}
        }
	})();
}

</script>
</html>